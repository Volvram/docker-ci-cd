name: Build and Push Docker Stack

on: [push]

env:
  APP_VERSION: ${{ github.sha }}  # Версия = хеш коммита

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # Сборка node-optimized (production)
      - name: Build node-optimized
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/node-optimized:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/node-optimized:${{ env.APP_VERSION }}

      # Сборка node-regular (development)
      - name: Build node-regular
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile_non_optimized
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/node-regular:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/node-regular:${{ env.APP_VERSION }}

      # Подготовка тестового окружения
      - name: Prepare test environment
        run: |
          echo "APP_VERSION=${{ env.APP_VERSION }}" > .env
          cat .env

      # Запуск всего стека и тестирование
      - name: Test stack
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.3/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version
          
          docker-compose up -d -f docker-compose.ci.yml
          
          sleep 15
          
          echo  "Testing production (via nginx)..."
          curl -s http://localhost:80 | grep "Hello from" || exit 1
          
          echo "Testing development..."
          curl -s http://localhost:3000 | grep "Hello from" || exit 1
          
          echo "Testing MongoDB connection..."
          docker exec $$(docker-compose -f docker-compose.ci.yml ps -q node-optimized) \
            node -e "require('mongoose').connect('mongodb://mongo:27017/mydb').then(() => process.exit(0)).catch(e => { console.error(e); process.exit(1) })"

      - name: Debug logs
        if: always()
        run: |
          docker-compose -f docker-compose.ci.yml logs